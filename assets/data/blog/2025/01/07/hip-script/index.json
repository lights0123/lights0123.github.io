{"hash":"2444d141b30d78a3cbc0576517772943cc1f9177","data":{"post":{"id":"757854843a4e697a7f6d7e276735e562","title":"HipScript","description":"By chaining several compilers, you can run CUDA code in the browser!","content":"<p>By chaining <a href=\"https://github.com/CHIP-SPV/chipStar/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">chipStar</a> (a HIP and NVIDIA® CUDA® to OpenCL compiler), <a href=\"https://github.com/google/clspv/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Clspv</a> (an OpenCL to Vulkan compiler), and <a href=\"https://dawn.googlesource.com/dawn/+/refs/heads/main/src/tint/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Tint</a> (among others, a Vulkan shader to WebGPU shader compiler), you can run CUDA code in the browser!</p>\n<p><a href=\"https://hipscript.lights0123.com/\" target=\"_blank\" rel=\"noopener\" class=\"xl:col-span-3 py-3 bg-gray-600 flex justify-center items-center text-white bg-gradient-cool font-bold text-3xl\">Try it out! ↗</a></p>\n<p><a href=\"https://github.com/lights0123/hipscript/\" target=\"_blank\" rel=\"noopener\" class=\"xl:col-span-3 py-3 flex justify-center items-center text-white bg-gray-800 font-bold text-3xl\">Source on GitHub ↗</a></p>\n<div class=\"light-only\">\n<p><img class=\"g-image g-image--lazy g-image--loading\" src=\"data:image/svg+xml,%3csvg fill='none' viewBox='0 0 1555 404' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3e%3cdefs%3e%3cfilter id='__svg-blur-5722373ef06b449b9f8bddd335de97a1'%3e%3cfeGaussianBlur in='SourceGraphic' stdDeviation='40'/%3e%3c/filter%3e%3c/defs%3e%3cimage x='0' y='0' filter='url(%23__svg-blur-5722373ef06b449b9f8bddd335de97a1)' width='1555' height='404' xlink:href='data:image/svg%2bxml%3bbase64%2ciVBORw0KGgoAAAANSUhEUgAAAEAAAAARCAYAAABtu6qMAAAACXBIWXMAAAsTAAALEwEAmpwYAAAIYElEQVRYw41XiY6bSBOe93%2bePMBqpfxKNsmMLwzmvm8wGHNDf7%2bqPDiT7Gq1LZW6afqo86vqFwCLEGKh/nfK83yJomgJAn9R1ctiWfaSZdlSFMWSpuk/7un7fqnraqmqehmn6W//p2lawjDkc5I0XeI4XpIkYaLxx7XzPC%2b3ul6u1%2bvSdu0v/6qqYv7KsuSe9rftY03b3hfDMHluWdenLEEQLL7v8zzdT/SC9zbPM9I0RRzHTG9vb9jv9xiHEXV1hW1Z2O0PcBwX87zAMEzIsgxVVXG73TAMA251DcMwcDzsoRsGoihG3/e43%2b8oyxKWZeP79%2b%2bPtbcbTNOAaVpwHAfruiIMQ5iGgev1yvt834OiKDhLEt/bti2q6sq80T1918G2bQSBzzzRmPaGYYDj8QRdU1EUJQ77Pez3O5I4RhhGLG9VVXgRQggAoigKkec5fYppmkTTNMJ1HXE6HcVZlsRRkoSqquJw2Ivj6SR0QxfzMos4DoWqaSJOYmHZpgjCQNiOI4qyEK5rC9fzhGEawrItHr%2b%2bvYqqqkSRF8LQdaHpujAMQ9xuNxGGoWiam0iTWMiKIizLFEmaiigMhGU7wjJNoeuaME1LKIoihmEQvu8Lx3HEPC8853m%2bkM9nIUmSOOz3/P3jx3fhui7L2fcdn0nj%2b/0uXh7ygzVX1zWPt7mhG1AkJdq6xeWs4fOfX9Bc76iLGxNmPEmMgJioF0zLsD6%2bp59r2NO6BVmSs/bL8oqyLFAUBXtI0zT4r434JY81TZN7OoO8hv%2bVBXux5/uYponnsiyD67p4fX3F4XBAEAS85hkC5JLkqltblhVTsyCLcli6i9CLoZw1KLIO1w4QeCE01eS5LCkwdCO6pkffDhi7CUM7orv3PNc1A/r7g%2bZhwdyuz3tI2RuRi/4%2bT60ockRRhDTNOASyLEd1vUKSJCRJ8s7vwjTP0y%2bKojPyPMflcuFw8n2flbed/UKxQBvpINIkfc/LjHVcMXUzBASGecAwDRjf%2b6IsOaYMy4JlO9ANE6Ztw3ZdaIQBkoSLpsFyHF7nuC6iOEaaZajvN/YWUpjjOmwFsgzhwIZBpIinAoRghh2H8OMHC0IYsNvtYFoWG44893g8QtU0XC4KFJlIhqJcGBdO0plxica0n3Bhay8EPHSpbTvwXJcVQXPXskKbDLgFLdq4R5cNaNMBUzO/u1SOOE5%2b0TZ5Tdd1DFiyQuDY4F3Rz7Y/HpBHBaZhRpIm7KIk8MN6M1t6HMe/uXyaJuzSFCp5lrFCf64TfO9DDpsVSkBLIUHASf3Q9xxiRDRH/%2bnuF4rFy0WF6zi4XitGd2IsSzIk5xK5UqM0byi0GplcsUI21yIl9P2Afhj44ONJgqYb8PwAumnhQEhsmLyGLhzHCYfjEcbFRJ7mcF2HLULxuNu9QVYujNB01oZJ1H/69Am6bnCI0j9SFmPUMPB/MhoR/dtcmxRFHlVV9fMcmnv0D9yhe18oPjRNY61FYQhZVpAX%2bQOoghtqt2Whr1aDq908wuL9EttxoWo6u9jb7oC3/QE/Xnf4/voG6SxDkhUW6qJqMEwLqqrjWlXACkjHMzPddy0M04R0OmEYR2aMUiFZk3iLopDDiJglz6SUdzqd8PrjB68la27YQXyRkiicKCQ2/Difz9BUlQEzCCNYtv0E0he6iA4nIoCgzcRYHCaYmomtX5oNKqdBrtYMYhvofIylrZGrmZYNVTf/0ZX3hwPko4L6%2bojdOI5woVwvy48cHj2%2bbcvE4XCEoshsFJljWoFlWRz7ZDTinXglRRDK05g8mgQmtKdGyunalhXT9f0jHIaB/3EWICZIiyS853nMVNPcMPYTpvuMPh/R5xNnhL6YHnUYYUCeM6htyqBGhY%2bqG2wx6azgJMmo6potQ4UKYYR0PnMqHfsRaZY%2b91P8UyMBCd3LouDzdF1jRUjSCUkS49Y0HOcfMxaNt1RKCiA8IIVsyE89eQ8RYcwWMrT%2bmQYfgv/Mw8u4cs5u%2bhsjd3WrULePnlzI8Xzopslo79PhcQTH8zgbUO/6/sN1KX1lGfKieGaBpV0x9TOKsmBGiFmKVyIyAvVbmFE1SBhFAEhKpHlSAO0jryW3plAhbyPBiT6CHCm2riuO%2b39qL1v8EBOkRXYbsWJdVozNjDK9IvQTBG4EXbVg6g7ypETgxlwfuKaP7tZjameM9%2bln382Y%2b4VpGRZOq2J%2bFEjDbfrXIoeM8cj7KVtpS3UkKPFJoUKNlPDHH3/wPJXhtIbqg7br2Ivr%2bvYssIIw/KXm2OjlI2qS%2b3ysBNdV4FY2GO8jjrszFz1zP6Op7lzU4L1uoacUP6fWB23fJDDROgnGDlLK0q%2bYp4WZIobJfYna9s6CkgU/FjFkyd9pUxBZ/6%2b//oLveU8ck88SZEVh0KP6g7yFFElpc5NLfMjNz7cA1edlWfJ4XVcxDqPwPI/fB9fqKnb7nfj8v8/ioqqiud9FEASivJZiGAfRDz1Tc2%2b4pm/bu2i7VnRdxz19Lys9OlfuoygSSZKIuq6FYehit3sTNe9ruZ63LIvfBXEc8xuF%2bNreKmma8je9A6iW1zRNbDIQ0ZlB4Iswip9zRHmWPdd9XP/EAAoFCgHSGAHR169f8e3bN/7nOjbnYQInWab0lbHV6CVI6%2blFZ%2bg6oy8BDsUx9Zx2gscLj9YQ0FIV9%2bXLV74/8H2Ob1pHld6yruzO5AXi9wrqX8LlGbofSumPlqbztpL5bxgAYBSCilOM23hdVx43TTMGgT8ahj7quj46jj1eLpdRVbXR9/2x67rnvv9C27lVVY1BEIyWZY2GYYy2bfOY5vI8/4WXfyNasywL74vjePQ8j88yTZPPc113jKKIaZqm8XdZif4PhpkVR0tfBqEAAAAASUVORK5CYII=' /%3e%3c/svg%3e\" width=\"1555\" alt=\"foo\" data-srcset=\"/assets/static/hipscript.82a2fbd.25bbe5d1d695cc44a24a0a4515000949.svg 480w, /assets/static/hipscript.cbab2cf.25bbe5d1d695cc44a24a0a4515000949.svg 1024w, /assets/static/hipscript.a72e906.25bbe5d1d695cc44a24a0a4515000949.svg 1555w\" data-sizes=\"(max-width: 1555px) 100vw, 1555px\" data-src=\"/assets/static/hipscript.a72e906.25bbe5d1d695cc44a24a0a4515000949.svg\"><noscript><img class=\"g-image g-image--lazy g-image--loaded\" src=\"/assets/static/hipscript.a72e906.25bbe5d1d695cc44a24a0a4515000949.svg\" width=\"1555\" alt=\"foo\"></noscript></p>\n</div>\n<div class=\"dark-only\">\n<p><img class=\"g-image g-image--lazy g-image--loading\" src=\"data:image/svg+xml,%3csvg fill='none' viewBox='0 0 1555 404' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3e%3cdefs%3e%3cfilter id='__svg-blur-28003b984860f8a9d45ee2c095d45b2b'%3e%3cfeGaussianBlur in='SourceGraphic' stdDeviation='40'/%3e%3c/filter%3e%3c/defs%3e%3cimage x='0' y='0' filter='url(%23__svg-blur-28003b984860f8a9d45ee2c095d45b2b)' width='1555' height='404' xlink:href='data:image/svg%2bxml%3bbase64%2ciVBORw0KGgoAAAANSUhEUgAAAEAAAAARCAYAAABtu6qMAAAACXBIWXMAAAsTAAALEwEAmpwYAAAJ2ElEQVRYw5VXa4wkVRWu6Z7p53T39Ptxz3eqn9PTM/2Y6a7q6Vs9M927O%2bzKAmt0YQUCixANmwWCD1AwRH7IIysLgQVj2FU2PAIEQoxKoitmTdQf%2bkcTowQT/WHiH2PwBzExitrmVtUMzbAarOR21%2bPWrfud853vnKNpmqYB0C51AEgzcwFgAnODGRUAGWZOAshe6p088gEBxAgixsjNXWLNWQAFZk4zIwvmPDPn1HoA8tNz08h4CRQliLiACO1ZZwFAipkTzJwC7DVCzjMOC4gagbI6yOPOTwEgZoY7N62w7IJ3N2ZvAuA8gD6DjTJX/DqXF0hQBSCDmUs1rs4y8yIzt5j15SIXoxWu%2bJn1GIEWAe4CWGRAlLkaKHJxXudiUme9yqzLMlcCDjCuMVAFUNIZHrVBADUACQYCAoIJtEKgNkGUGAgTEFd7U%2bsDCAK2U1BEwQugDHCcACKINQKWGKSA99SzAooeB5/9HYV3YdoAyqupkl7SCGKuxKVIHvlihtKdjEg3UdFXCyXRyIpMN4/cao4yNS2neVOUzueRXUpTMpehTDlNSZGhdCkmIokUpYspSnCGUrUUJcsZSnKOsmZcRGPMeoocI9UVaGZEnY1xhMA5BpoEVAVEVoAFg8oAqgSqu0ZbAeCHc5RcA6ywTVe0AHTIBk7q1kDZSOEkUACgrMuU%2bWkDKMtG1fnPt/5s3zu6dGPwWOPmwk04EdvfPdLdMg9f%2bcn6HYkbFm9NHV86mZ5sTWYn%2byezk9Fk7vebE9/fxhPfWxv/9P1281%2b%2bi4PfBf46nsy9u28yNzkwmZtsT%2bxweLb/RmhcPZRPUzJW5GICzEk3pBIA5rUPeTAQZ3DGMQZnABUGCDggOUGgvANezO6GM1BkcN9hqAqFqZADEAEQ3rn%2bdPsu7/fWfxM7NjyhH7auax6xbqxsW0fNA9bHetvDj9cPDK%2bpjgdXdkbyqt6Vg%2bvFZ/sPhj7Vvzt6e//%2b%2bXvMR0J390/Nn%2bzfF7mt/%2bXonf2vRO8yH458zngw8lT31cCF4Vu7QMflyzRBBQ0MNWam9qMB5J5zikAF5TmAVeynBUg5rA0gp%2bYIwMMgDwGz04bKIqu58b7ssga2sRnviRIzK/ooYcgs6kuzWkDzXBi%2b5T9nvO4Ij9TmtKE9ZtX5sjTSLSlrHWktdaRVX5XD5Y4cLnXksNqRw5VVudHvSKvVkdZiW1q1tiWrTWtAbSnz%2be1a9O2tif9k60uhLGWKOut5xzO2d1wNwgwzKy9rmpDKAHEBKhFIukBMAAZAKiQiBMQArAJYImCZnPBpOvqBMoFUOHQFSJ0vA5Sc9rxgpcSOgOjMei6PvDBKg8T5wffptPlc8Yz5Kj1jvph71Hw%2bf978Tky9Z8p9eUPuo2lrd%2bXY05X7wz05rnXlxtqa3Iy92/zj%2b6hbWaobV9ePi8%2b3H/BnKJ0F01yB9Jks2COQtzMEAN9eygsgSzalKeHQmfJ5iLkpHEHXeGVbEwE/gwMAh5SgAqz0Yt5lesi9nlXxsiBADQKUysYJopamRNYob%2bROGWd7Z/pnV8%2bY5xqPm%2bdap82z3dPmN20xuWxwTOvJUa4nR0FDjgMKbFdu9rty1OzJrXJPbiyvya1BV26uGHIzuLa%2bGdg%2bdMxfXW4YVnm0YpatXI6yRQGhPAoBMgChREwoIWSwivGY%2bgdwlIFFnfUwgyMAe1wd8LvalXNHZLF52Y5BlKGyzBxzR9xNmXFXc9QgOz8SaElZjeyPUzMlEkmrMs7dt/aY/lT/bPWMebb4mHm%2bfsY8X3/YfCrcXD9qf6QnR4s9OWr35MjsydGwJ8fDnhxtOWNsGNa415Pjbk%2bOOj05WjbkuG1%2b5GBqcv3Es1xsrWUpkwVXg4CoCYgOUPAx7M3VHBGzc7diRMkxkhACQsmXovu6%2bzwEwDbISqeh8ITd%2bWuOINpz2uSERxUgtUZlR0i1qbyoDmZwSVHTLA/oG/2L0YfNpxunzHON0%2bYzi181n24/0P%2bqX728Objc25OjzF6qrspxsCtHS1250exIy7/3ealeNQblre64eiieEnFVC%2bTJFidSqSvuMAAqdlV%2b77rC1cRuTAt1X6XBJXfvWdebGZcFSiTVWutO6JDHNVLYDRNVX/hdluTUj6KHmmCXSDoXowsiOn9i5Z7gc%2bsXIk8ar2XOG9/Ovmj8MPqE8VJmsjrxqpf78kBO6YA635BXeB3wG7wmt1qKGV252evKLdOQW4mbBl/UBv1t79WHT3przZXVE40vJG5Z%2bUwwS2nbgMzsUULsbkqltTaBkwwqkF0n0JrK6w5AoWK4zFMp0wXnpFLmBWYO7ig/g5UBG8ystE5VgoWpyjMxLYax6Tz8svyp73njYkjb0EJJKx9Ny1LMb0Xmi3JloSUH9aZcr7SlXO5Iq922BnpLDtCSstK2rHpbympbyrLKAC0puWUN8k05yKzKYS63XY3%2bTP4p/FD3XDAuoqo6zIGdstTdlHJEtuimQHKuGyqn6wxvvtjSXKHLuaytuiWxTwFnRhDMYZ3Zz8xzupPhFLbkf6v3Z3YKhd1JCU27o3O/52Xzx9HrhreLK6zryoetG2qHrGOdy61rW9cMb6Uj1vHaFYPrm0cGNzbu7T%2by8DXjtfCj5guRJ4yXw48bL82fMV4Jv2BcDJ43LgRf7P0o8IPem75f9P4y%2b8rqTwLn%2bq/H/leR42644IqYEq6oEjLYNb%2b9z/gOhQEcdOM86rynxLMQKoAiAMXIFkOKqPRRQEnTmRTj3DoD2t5S2ElxZcu%2b94j5nOeW%2bp3JewsPhfcZV1n7jSO9U4kn/Z%2bo3rxwS%2bn28KQ7sY339nji/cP%2biXfy0Ylncu3E8%2b%2bDE%2b87ByfeX%2b/7%2b%2byb%2b/4x98vxO3PPDt4IfL3/rdB3N34VPL5822yKEqo/sFnH4DDsYYMIvr8YspV%2b79gxkPL%2b0GEN2TrmlMGk9EKxpuiwhbIM5JO8pH2g%2bZsywMJOTBSQnylyyaeakQQtpBIUWxBFMgQXxjnkGguYD%2beQpTRScR%2b8vmBhzh8s%2bPwxEZlPiFhkvhAMRQqhUKjgCzrDH9JCmlPlzWgzBRTsOFSeFaBFAhk6UxSOFq24DY5wPZxyU1rS9X7Wvfa5sV9fxtJUvaC8zlD68YHO9j2slzSAx/1AhZlVR7bJ4A33WZmJ6k61xW1VhBS5qHL1MjPb85m5DnDHVWxV1a0weBGsGlCu68w1nXWdmVWXuZVFaYYAHSCVAZQRyjlKetmu621gMx%2bmJ3DrgPQOhvc/I49w6B7aqft3qb9nEW0P7Wam%2bgPFLdW2Lrr5tQG7zbSPoPZ/HFPrLripV6l5lZ11K%2b691M58Xdd3N3ypMeU4clMiuwJZYWc93b1fgNsj7AX/H/BGNdbVJeE0AAAAAElFTkSuQmCC' /%3e%3c/svg%3e\" width=\"1555\" alt=\"foo\" data-srcset=\"/assets/static/hipscript.dark.82a2fbd.4b8b9933739c7717f269ee90e2eb2fff.svg 480w, /assets/static/hipscript.dark.cbab2cf.4b8b9933739c7717f269ee90e2eb2fff.svg 1024w, /assets/static/hipscript.dark.a72e906.4b8b9933739c7717f269ee90e2eb2fff.svg 1555w\" data-sizes=\"(max-width: 1555px) 100vw, 1555px\" data-src=\"/assets/static/hipscript.dark.a72e906.4b8b9933739c7717f269ee90e2eb2fff.svg\"><noscript><img class=\"g-image g-image--lazy g-image--loaded\" src=\"/assets/static/hipscript.dark.a72e906.4b8b9933739c7717f269ee90e2eb2fff.svg\" width=\"1555\" alt=\"foo\"></noscript></p>\n</div>\n<h1 id=\"what-is-hip-cuda\"><a href=\"#what-is-hip-cuda\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>What is HIP? CUDA?</h1>\n<p>CUDA is the name of the API developed by NVIDIA for GPGPU (General-purpose computing on graphics processing units). A CUDA compiler compiles the same C++ file twice: once for the GPU architecture, and once for the host. This way, you can share code between them, and all data types remain the same. CUDA also provides library functions for interacting with the GPU and special syntax for launching CUDA kernels.</p>\n<p>CUDA kernels are written for one thread, but are then executed by many. Several threads (of the programmer's choice) form a \"block\", which can share access to fast on-chip memory. There are then some number of blocks in a \"grid\".</p>\n<p>AMD came along and created HIP, their competitor to CUDA. It has identical syntax and concepts to CUDA—just pretty much does <code class=\"language-text\">sed s/cuda/hip/g</code>! This allows projects like chipStar, which allows HIP code to run on any OpenCL-supported device, to provide a header file that <code class=\"language-text\">#define</code>s CUDA calls into HIP ones.</p>\n<h1 id=\"supported-hipcuda-features\"><a href=\"#supported-hipcuda-features\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Supported HIP/CUDA features</h1>\n<p>This project currently supports a <strong>very basic</strong> subset of HIP and CUDA. However, the supported subset already provides a fair bit of material for learning GPU programming:</p>\n<ul>\n<li>\n<p>Basic kernel launch syntax</p>\n<ul>\n<li>C++ is fully supported, so use generic kernels as you please! The compiler will analyze calls from the CPU side to determine what functions must be generated.</li>\n</ul>\n</li>\n<li>Static and dynamic shared memory</li>\n<li><code class=\"language-text\">__syncthreads</code> (as long as it's in a uniform control flow path, i.e. no early returns or if statements based on <code class=\"language-text\">threadIdx</code>)</li>\n<li><code class=\"language-text\">printf</code> (format string and values are written to a hidden buffer by the GPU, then formatted by the CPU afterwards)</li>\n<li><code class=\"language-text\">assert</code> (although Tint doesn't allow <code class=\"language-text\">__syncthreads</code> afterwards due to <a href=\"https://github.com/gpuweb/gpuweb/issues/3479#issuecomment-1467271026\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">an overzealous control-flow checker</a>)</li>\n<li>\n<p><code class=\"language-text\">hipMalloc</code>, <code class=\"language-text\">hipFree</code>, <code class=\"language-text\">hipMemcpy</code>, <code class=\"language-text\">hipGetSymbolAddress</code>, <code class=\"language-text\">hipMemcpyToSymbol</code>, <code class=\"language-text\">hipLaunchKernel</code>, <code class=\"language-text\">hipLaunchKernelGGL</code>, <code class=\"language-text\">hipGetLastError</code>, <code class=\"language-text\">hipPeekAtLastError</code>, <code class=\"language-text\">hipGetErrorName</code>, <code class=\"language-text\">hipGetErrorString</code></p>\n<ul>\n<li>and corresponding CUDA functions</li>\n</ul>\n</li>\n<li><code class=\"language-text\">__device__</code> and <code class=\"language-text\">__constant__</code> variables (although the latter are treated the same as the former, i.e. read-write)</li>\n</ul>\n<h2 id=\"unsupported-features\"><a href=\"#unsupported-features\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Unsupported Features</h2>\n<ul>\n<li>\n<p>any functions not listed above</p>\n<ul>\n<li>streams</li>\n<li>graphs</li>\n<li>managed/asynchronous memory transfers</li>\n</ul>\n</li>\n<li>64-bit floating point (WebGPU limitation) and 16-bit floating point (Tint limitation) numbers</li>\n<li>integers other than 32-bit signed and unsigned integers (WebGPU limitation)</li>\n<li>\n<p>many things with pointers:</p>\n<ul>\n<li>passing a pointer to a kernel not directly as a parameter (e.g. in a struct)</li>\n<li>\n<p><strong>pointer manipulation on the CPU side</strong>: note this means that you cannot pass an offset to <code class=\"language-text\">hipMemcpy</code> or a kernel</p>\n<ul>\n<li>WebGPU would allow a 128-byte aligned offset passed to a kernel. However, I decided not to implement that because of the limited 32-bit address space of WASM.</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>warp intrinsics (should be possible, although currently requires experimental Chrome flags)</li>\n<li>dynamic parallelism (could be polyfilled by converting calls to writes in a buffer, then launching kernels from the CPU)</li>\n<li>any GPU libraries: cuDNN, cuBLAS, cuRAND, ...</li>\n<li>Cooperative Groups</li>\n<li>Inline PTX (<a href=\"https://github.com/CHIP-SPV/chipStar/discussions/904#discussioncomment-10255598\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">although it has been done before</a>)</li>\n</ul>\n<h1 id=\"how-its-built\"><a href=\"#how-its-built\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>How it's built</h1>\n<p>Using LLVM compiled to WebAssembly, the input source code is first passed through Clang, which already understands HIP and CUDA. These languages are compiled in two passes—for the GPU using SPIR-V and for the CPU using WebAssembly. These use WebAssembly headers, meaning all types are the same size. Then, the GPU side code is fed through chipStar, a HIP-to-OpenCL translator. I keep its output as LLVM bitcode to immediately pass through Clspv, converting it to a Vulkan shader. Finally, Google's Tint from the Dawn project translates it to WGSL. A WebAssembly implementation of the HIP API then coordinates kernel launches.</p>\n<p>I aimed to keep file size in mind. To package as large of a project LLVM is, I wanted to make sure I wasn't duplicating any code—for example, the WASM backend code shouldn't exist separately in the compiler and linker. This is traditionally done with dynamic linking, which isn't supported by Wasmer (it is by Emscripten, but by going through a JS intermediate: slow). Thankfully, LLVM has an option just for this case: <code class=\"language-text\">LLVM_TOOL_LLVM_DRIVER_BUILD</code>. By setting this flag, LLVM creates a single entrypoint that statically links to every executable. This way, you can just pass the desired tool as arg0 or arg1, like <code class=\"language-text\">llvm clang++ file.cpp</code>.</p>\n<p>I then bundled the chipStar LLVM passes in the LLVM source code. I added a command-line flag that allows Clang to run the passes. Typically they're run with <code class=\"language-text\">opt</code>, but that isn't compatible with the driver. Clspv and SPIRV-Tools were added as <code class=\"language-text\">LLVM_EXTERNAL_PROJECTS</code> to be additionally integrated in the single tool.</p>\n<h1 id=\"issues-i-encountered\"><a href=\"#issues-i-encountered\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Issues I encountered</h1>\n<h2 id=\"wasmer-runtime-workarounds\"><a href=\"#wasmer-runtime-workarounds\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Wasmer Runtime Workarounds</h2>\n<p>I compiled LLVM using the WASIX toolchain, because it offers much needed functions not available in vanilla WASI, and Emscripten doesn't feel great for porting traditional command-line applications. However, the Wasmer SDK is the only implementation of the WASIX specification, and the JS version has some bugs. <a href=\"https://github.com/wasmerio/wasmer-js/issues/407\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">You can't load a WASM file directly</a>, loading their \"webc\" container directly just failed with a generic <code class=\"language-text\">Unreachable</code> error, and the recommended Wasmer CDN doesn't compress files—even when a 5x compression ratio is possible. This large file size then causes Chrome to not cache anything at all! So, I set the \"API endpoint\" of the CDN to a simple <code class=\"language-text\">file:</code> URI that points to a <code class=\"language-text\">blob:</code> URI for the actual WASM file. On the page load, I handle downloading and caching the binary manually.</p>\n<p>Then, I was running into issues where I'd get another generic <code class=\"language-text\">Unreachable</code> after launching more than a couple programs. I worked around this by just spawning new Web Workers and completely re-loading the SDK in each. Very thankfully, it seems like Chrome caches <code class=\"language-text\">WebAssembly.compile</code> calls with the same binary input so there isn't too much of a performance penalty.</p>\n<p>I couldn't debug these issues because <a href=\"https://github.com/wasmerio/wasmer-js/issues/437\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">the Wasmer SDK source is currently unable to be built</a> and the package on NPM doesn't ship with debug symbols.</p>\n<h2 id=\"compressed-data-on-cloudflare-r2\"><a href=\"#compressed-data-on-cloudflare-r2\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Compressed Data on Cloudflare R2</h2>\n<p>GZip compression brought by LLVM bundle from 75MB to 21MB, and Brotli further to 15MB. I decided to use Brotli because of these savings, and it's supported on all modern browsers. I decided to use Cloudflare R2 as my storage provider, on which <a href=\"https://alexi.sh/blog/2023/03/using-r2-to-store-and-serve-compressed-content/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">others have had success uploading pre-compressed data to</a> since it won't compress to Brotli for you. However, I was encountering issues with the upload step, since rclone was detecting an incorrectly-sized upload. Turns out, you need to specify <code class=\"language-text\">Cache-Control: no-transform</code>. That has the bonus of correctly supporting custom domains with R2 (strongly encouraged for production), since it tells Cloudflare not to uncompress the data, bypassing the entire purpose of doing this.</p>\n<div class=\"gridsome-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">rclone copyto --progress --header-upload \"Content-Type: application/octet-stream\" --header-upload \"Content-Encoding: br\" --header-upload \"Cache-Control: no-transform\" $file $connection:$bucket/$serverpath</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<p>Before I discovered that, I used gdb to set a breakpoint on <code class=\"language-text\">github.com/rclone/rclone/fs/operations.(*copy).removeFailedCopy</code> to stop deleting the (sucessfully, but it didn't know that) uploaded file.</p>\n","path":"/blog/2025/01/07/hip-script/","headings":[{"depth":1,"value":"What is HIP? CUDA?","anchor":"#what-is-hip-cuda"},{"depth":1,"value":"Supported HIP/CUDA features","anchor":"#supported-hipcuda-features"},{"depth":2,"value":"Unsupported Features","anchor":"#unsupported-features"},{"depth":1,"value":"How it's built","anchor":"#how-its-built"},{"depth":1,"value":"Issues I encountered","anchor":"#issues-i-encountered"},{"depth":2,"value":"Wasmer Runtime Workarounds","anchor":"#wasmer-runtime-workarounds"},{"depth":2,"value":"Compressed Data on Cloudflare R2","anchor":"#compressed-data-on-cloudflare-r2"}],"date":"January 7, 2025","rawDate":"2025-01-07T00:00:00.000Z","updated":null,"rawUpdated":null,"timeToRead":5}},"context":{}}