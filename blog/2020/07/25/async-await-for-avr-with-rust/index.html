<!DOCTYPE html>
<html data-html-server-rendered="true" lang="en" data-vue-tag="%7B%22lang%22:%7B%22ssr%22:%22en%22%7D%7D">
  <head>
    <title>Async/Await for AVR with Rust - Ben Schattinger</title><meta name="gridsome:hash" content="140084528d1a1695accb1fbd2d3099eab2fed971"><meta data-vue-tag="ssr" charset="utf-8"><meta data-vue-tag="ssr" name="generator" content="Gridsome v0.7.23"><meta data-vue-tag="ssr" data-key="viewport" name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"><meta data-vue-tag="ssr" data-key="format-detection" name="format-detection" content="telephone=no"><meta data-vue-tag="ssr" property="og:site_name" content="Ben Schattinger"><meta data-vue-tag="ssr" property="og:url" content="https://lights0123.com/blog/2020/07/25/async-await-for-avr-with-rust/"><meta data-vue-tag="ssr" property="og:image" content="https://lights0123.com/favicon.png" data-key="og:image"><meta data-vue-tag="ssr" property="og:type" content="article" data-key="og:type"><meta data-vue-tag="ssr" property="og:title" content="Async/Await for AVR with Rust"><meta data-vue-tag="ssr" name="description" content="With the recent ability for Rust to target AVR, it&#x27;s time for me to bring my favorite feature of Rust to Arduino: async/await. Asynchronous code allows for doing (seemingly) multiple things at once, without the memory or CPU overhead of threads."><meta data-vue-tag="ssr" property="og:description" content="With the recent ability for Rust to target AVR, it&#x27;s time for me to bring my favorite feature of Rust to Arduino: async/await. Asynchronous code allows for doing (seemingly) multiple things at once, without the memory or CPU overhead of threads." data-key="og:description"><meta data-vue-tag="ssr" property="article:author:first_name" content="Ben"><meta data-vue-tag="ssr" property="article:author:last_name" content="Schattinger"><meta data-vue-tag="ssr" property="article:published_time" content="2020-07-25T00:00:00.000Z"><meta data-vue-tag="ssr" property="article:modified_time" content="2020-07-26T00:00:00.000Z"><link data-vue-tag="ssr" rel="icon" href="data:,"><link data-vue-tag="ssr" rel="icon" type="image/png" sizes="16x16" href="/assets/static/favicon.ce0531f.4bccc38557c3841ee3c2a16e7276a78f.png"><link data-vue-tag="ssr" rel="icon" type="image/png" sizes="32x32" href="/assets/static/favicon.ac8d93a.4bccc38557c3841ee3c2a16e7276a78f.png"><link data-vue-tag="ssr" rel="icon" type="image/png" sizes="96x96" href="/assets/static/favicon.b9532cc.4bccc38557c3841ee3c2a16e7276a78f.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="76x76" href="/assets/static/favicon.f22e9f3.4bccc38557c3841ee3c2a16e7276a78f.png"><link rel="preload" href="/assets/css/0.styles.bbcae30a.css" as="style"><link rel="preload" href="/assets/js/app.1b2a94ac.js" as="script"><link rel="preload" href="/assets/js/page--src--templates--post-vue.46cc7684.js" as="script"><link rel="prefetch" href="/assets/js/page--src--pages--2021-schedule-vue.48eed297.js"><link rel="prefetch" href="/assets/js/page--src--pages--404-vue.053ada8c.js"><link rel="prefetch" href="/assets/js/page--src--pages--about-vue.21ce1d65.js"><link rel="prefetch" href="/assets/js/page--src--pages--blog-vue.769e481c.js"><link rel="prefetch" href="/assets/js/page--src--pages--index-vue.9bf83519.js"><link rel="prefetch" href="/assets/js/page--src--pages--n-link-vue.fa527512.js"><link rel="prefetch" href="/assets/js/page--src--pages--privacy-vue.be8360a4.js"><link rel="prefetch" href="/assets/js/page--src--templates--tag-vue.bf0f3475.js"><link rel="prefetch" href="/assets/js/vendors~page--src--pages--2021-schedule-vue.1754a8cc.js"><link rel="stylesheet" href="/assets/css/0.styles.bbcae30a.css"><script data-vue-tag="ssr" type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://lights0123.com/blog/2020/07/25/async-await-for-avr-with-rust/"},"headline":"Async/Await for AVR with Rust","description":"With the recent ability for Rust to target AVR, it's time for me to bring my favorite feature of Rust to Arduino: async/await. Asynchronous code allows for doing (seemingly) multiple things at once, without the memory or CPU overhead of threads.","datePublished":"2020-07-25T00:00:00.000Z","dateModified":"2020-07-26T00:00:00.000Z","author":{"@type":"Person","name":"Ben Schattinger"}}</script><noscript data-vue-tag="ssr"><style>.g-image--loading{display:none;}</style></noscript>
  </head>
  <body >
    <div id="app" data-server-rendered="true" class="h-full"><div class="flex flex-col h-full" data-v-47adcb3e><header class="header"><nav class="p-2 bg-blue-500" data-v-70f7a70e><div class="container mx-auto flex items-center justify-between flex-wrap" data-v-70f7a70e><a href="/" class="flex items-center flex-shrink-0 text-ui-background mr-6 lg:mr-10 hide-if-active a" data-v-70f7a70e><span class="font-semibold text-3xl tracking-tight" data-v-70f7a70e>Ben Schattinger</span></a><div class="block lg:hidden" data-v-70f7a70e><button class="flex items-center px-3 py-2 border rounded text-blue-200 border-blue-400 hover:text-white hover:border-white" data-v-70f7a70e><svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" class="fill-current h-3 w-3" data-v-70f7a70e><title data-v-70f7a70e>Menu</title><path d="M0 3h20v2H0V3zm0 6h20v2H0V9zm0 6h20v2H0v-2z" data-v-70f7a70e></path></svg></button></div><div class="w-full block flex-grow lg:items-center lg:w-auto hidden lg-flex-important" data-v-70f7a70e><div class="text-lg lg:flex-grow" data-v-70f7a70e><a href="/" class="block mt-4 lg:inline-block lg:mt-0 text-blue-200 hover:text-white mr-4 px-2 pb-1 active" data-v-70f7a70e>
					Home
				</a><a href="/about" class="block mt-4 lg:inline-block lg:mt-0 text-blue-200 hover:text-white mr-4 px-2 pb-1" data-v-70f7a70e>
					About
				</a><a href="/blog" class="block mt-4 lg:inline-block lg:mt-0 text-blue-200 hover:text-white mr-4 px-2 pb-1 active" data-v-70f7a70e>
					Blog
				</a></div></div><div class="hidden lg:flex text-ui-background mt-6 lg:mt-0" data-v-70f7a70e><a href="https://www.linkedin.com/in/ben-schattinger-9414b0220/" rel="noopener" target="_blank" title="LinkedIn" class="mr-4" data-v-70f7a70e><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img" aria-label="LinkedIn" class="feather feather-linkedin" data-v-70f7a70e data-v-70f7a70e><path d="M16 8a6 6 0 016 6v7h-4v-7a2 2 0 00-2-2 2 2 0 00-2 2v7h-4v-7a6 6 0 016-6zM2 9h4v12H2z" data-v-70f7a70e data-v-70f7a70e></path><circle cx="4" cy="4" r="2" data-v-70f7a70e data-v-70f7a70e></circle></svg></a><a href="https://github.com/lights0123" rel="noopener" target="_blank" title="GitHub" data-v-70f7a70e><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img" aria-label="GitHub" class="feather feather-github" data-v-70f7a70e data-v-70f7a70e><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0020 4.77 5.07 5.07 0 0019.91 1S18.73.65 16 2.48a13.38 13.38 0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 005 4.77a5.44 5.44 0 00-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 009 18.13V22" data-v-70f7a70e data-v-70f7a70e></path></svg></a><button aria-label="Enable Dark Theme" title="Enable Dark Theme" class="ml-6" data-v-68ce12ca data-v-70f7a70e><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img" aria-label="Enable Dark Theme" class="feather feather-sun" data-v-68ce12ca data-v-68ce12ca><circle cx="12" cy="12" r="5" data-v-68ce12ca data-v-68ce12ca></circle><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" data-v-68ce12ca data-v-68ce12ca></path></svg></button></div></div></nav></header><main class="container mx-auto flex-grow px-2"><article class="flex flex-wrap items-start justify-start h-full" data-v-47adcb3e><div class="on-this-page order-2 w-full md:w-1/3 sm:pl-4 md:pl-6 lg:pl-8 sticky top-0" data-v-47adcb3e><div class="mt-8 sm:pl-4 md:pl-6 md:pt-12 lg:pl-8 sm:pb-16 sm:border-l border-ui-border md:mt-0" data-v-47adcb3e><h3 class="pt-0 mt-0 text-sm tracking-wide uppercase border-none">On this page</h3><div><ul><li class="font-semibold depth-1"><a href="/blog/2020/07/25/async-await-for-avr-with-rust/#introduction" class="relative flex items-center py-1 text-sm transition transform hover:translate-x-1"><span class="absolute w-2 h-2 -ml-3 rounded-full opacity-0 bg-ui-primary transition transform scale-0 origin-center"></span>
						Introduction
					</a></li><li class="border-t border-dashed border-ui-border pt-2 mt-2 font-semibold depth-1"><a href="/blog/2020/07/25/async-await-for-avr-with-rust/#what-even-is-asyncawait-anyways" class="relative flex items-center py-1 text-sm transition transform hover:translate-x-1"><span class="absolute w-2 h-2 -ml-3 rounded-full opacity-0 bg-ui-primary transition transform scale-0 origin-center"></span>
						What even is async/await, anyways?
					</a></li><li class="border-t border-dashed border-ui-border pt-2 mt-2 font-semibold depth-1"><a href="/blog/2020/07/25/async-await-for-avr-with-rust/#prior-work" class="relative flex items-center py-1 text-sm transition transform hover:translate-x-1"><span class="absolute w-2 h-2 -ml-3 rounded-full opacity-0 bg-ui-primary transition transform scale-0 origin-center"></span>
						Prior work
					</a></li><li class="depth-2"><a href="/blog/2020/07/25/async-await-for-avr-with-rust/#pseudo-asyncawait" class="relative flex items-center py-1 text-sm transition transform hover:translate-x-1 pl-2"><span class="absolute w-2 h-2 -ml-3 rounded-full opacity-0 bg-ui-primary transition transform scale-0 origin-center"></span>
						Pseudo-async/await
					</a></li><li class="border-t border-dashed border-ui-border pt-2 mt-2 font-semibold depth-1"><a href="/blog/2020/07/25/async-await-for-avr-with-rust/#putting-it-together" class="relative flex items-center py-1 text-sm transition transform hover:translate-x-1"><span class="absolute w-2 h-2 -ml-3 rounded-full opacity-0 bg-ui-primary transition transform scale-0 origin-center"></span>
						Putting it together
					</a></li><li class="depth-2"><a href="/blog/2020/07/25/async-await-for-avr-with-rust/#getting-started" class="relative flex items-center py-1 text-sm transition transform hover:translate-x-1 pl-2"><span class="absolute w-2 h-2 -ml-3 rounded-full opacity-0 bg-ui-primary transition transform scale-0 origin-center"></span>
						Getting started
					</a></li><li class="depth-2"><a href="/blog/2020/07/25/async-await-for-avr-with-rust/#compiling-and-running" class="relative flex items-center py-1 text-sm transition transform hover:translate-x-1 pl-2"><span class="absolute w-2 h-2 -ml-3 rounded-full opacity-0 bg-ui-primary transition transform scale-0 origin-center"></span>
						Compiling and Running
					</a></li><li class="depth-2"><a href="/blog/2020/07/25/async-await-for-avr-with-rust/#if-you-only-have-the-arduino-ide-installed" class="relative flex items-center py-1 text-sm transition transform hover:translate-x-1 pl-2"><span class="absolute w-2 h-2 -ml-3 rounded-full opacity-0 bg-ui-primary transition transform scale-0 origin-center"></span>
						If you only have the Arduino IDE installed
					</a></li><li class="depth-3"><a href="/blog/2020/07/25/async-await-for-avr-with-rust/#what-about-converting-to-hex-first" class="relative flex items-center py-1 text-sm transition transform hover:translate-x-1 pl-4"><span class="absolute w-2 h-2 -ml-3 rounded-full opacity-0 bg-ui-primary transition transform scale-0 origin-center"></span>
						What about converting to hex first?
					</a></li><li class="depth-2"><a href="/blog/2020/07/25/async-await-for-avr-with-rust/#onto-async-operations" class="relative flex items-center py-1 text-sm transition transform hover:translate-x-1 pl-2"><span class="absolute w-2 h-2 -ml-3 rounded-full opacity-0 bg-ui-primary transition transform scale-0 origin-center"></span>
						Onto async operations
					</a></li><li class="depth-3"><a href="/blog/2020/07/25/async-await-for-avr-with-rust/#why-do-i-always-return-1-byte-read" class="relative flex items-center py-1 text-sm transition transform hover:translate-x-1 pl-4"><span class="absolute w-2 h-2 -ml-3 rounded-full opacity-0 bg-ui-primary transition transform scale-0 origin-center"></span>
						Why do I always return 1 byte read?
					</a></li><li class="depth-2"><a href="/blog/2020/07/25/async-await-for-avr-with-rust/#writing-an-executor" class="relative flex items-center py-1 text-sm transition transform hover:translate-x-1 pl-2"><span class="absolute w-2 h-2 -ml-3 rounded-full opacity-0 bg-ui-primary transition transform scale-0 origin-center"></span>
						Writing an executor
					</a></li><li class="depth-3"><a href="/blog/2020/07/25/async-await-for-avr-with-rust/#why-not-the-vcell-crate" class="relative flex items-center py-1 text-sm transition transform hover:translate-x-1 pl-4"><span class="absolute w-2 h-2 -ml-3 rounded-full opacity-0 bg-ui-primary transition transform scale-0 origin-center"></span>
						Why not the vcell crate?
					</a></li><li class="depth-3"><a href="/blog/2020/07/25/async-await-for-avr-with-rust/#creating-a-vtable" class="relative flex items-center py-1 text-sm transition transform hover:translate-x-1 pl-4"><span class="absolute w-2 h-2 -ml-3 rounded-full opacity-0 bg-ui-primary transition transform scale-0 origin-center"></span>
						Creating a VTable
					</a></li><li class="depth-3"><a href="/blog/2020/07/25/async-await-for-avr-with-rust/#the-block_on-function" class="relative flex items-center py-1 text-sm transition transform hover:translate-x-1 pl-4"><span class="absolute w-2 h-2 -ml-3 rounded-full opacity-0 bg-ui-primary transition transform scale-0 origin-center"></span>
						The block_on function
					</a></li><li class="border-t border-dashed border-ui-border pt-2 mt-2 font-semibold depth-1"><a href="/blog/2020/07/25/async-await-for-avr-with-rust/#writing-asynchronous-code" class="relative flex items-center py-1 text-sm transition transform hover:translate-x-1"><span class="absolute w-2 h-2 -ml-3 rounded-full opacity-0 bg-ui-primary transition transform scale-0 origin-center"></span>
						Writing asynchronous code!
					</a></li><li class="depth-2"><a href="/blog/2020/07/25/async-await-for-avr-with-rust/#a-simple-demo" class="relative flex items-center py-1 text-sm transition transform hover:translate-x-1 pl-2"><span class="absolute w-2 h-2 -ml-3 rounded-full opacity-0 bg-ui-primary transition transform scale-0 origin-center"></span>
						A simple demo
					</a></li><li class="depth-2"><a href="/blog/2020/07/25/async-await-for-avr-with-rust/#a-bit-more-powerful" class="relative flex items-center py-1 text-sm transition transform hover:translate-x-1 pl-2"><span class="absolute w-2 h-2 -ml-3 rounded-full opacity-0 bg-ui-primary transition transform scale-0 origin-center"></span>
						A bit more powerful
					</a></li><li class="depth-3"><a href="/blog/2020/07/25/async-await-for-avr-with-rust/#why-do-we-need-to-lock" class="relative flex items-center py-1 text-sm transition transform hover:translate-x-1 pl-4"><span class="absolute w-2 h-2 -ml-3 rounded-full opacity-0 bg-ui-primary transition transform scale-0 origin-center"></span>
						Why do we need to lock?
					</a></li><li class="depth-3"><a href="/blog/2020/07/25/async-await-for-avr-with-rust/#whats-with-all-the-yielding" class="relative flex items-center py-1 text-sm transition transform hover:translate-x-1 pl-4"><span class="absolute w-2 h-2 -ml-3 rounded-full opacity-0 bg-ui-primary transition transform scale-0 origin-center"></span>
						What's with all the yielding?
					</a></li><li class="border-t border-dashed border-ui-border pt-2 mt-2 font-semibold depth-1"><a href="/blog/2020/07/25/async-await-for-avr-with-rust/#to-do" class="relative flex items-center py-1 text-sm transition transform hover:translate-x-1"><span class="absolute w-2 h-2 -ml-3 rounded-full opacity-0 bg-ui-primary transition transform scale-0 origin-center"></span>
						To Do
					</a></li><li class="border-t border-dashed border-ui-border pt-2 mt-2 font-semibold depth-1"><a href="/blog/2020/07/25/async-await-for-avr-with-rust/#final-code" class="relative flex items-center py-1 text-sm transition transform hover:translate-x-1"><span class="absolute w-2 h-2 -ml-3 rounded-full opacity-0 bg-ui-primary transition transform scale-0 origin-center"></span>
						Final code
					</a></li><li class="border-t border-dashed border-ui-border pt-2 mt-2 font-semibold depth-1"><a href="/blog/2020/07/25/async-await-for-avr-with-rust/#thanks-to" class="relative flex items-center py-1 text-sm transition transform hover:translate-x-1"><span class="absolute w-2 h-2 -ml-3 rounded-full opacity-0 bg-ui-primary transition transform scale-0 origin-center"></span>
						Thanks to
					</a></li></ul></div></div></div><div class="order-1 w-full md:w-2/3" data-v-47adcb3e><h1 class="text-5xl mb-0" data-v-47adcb3e>Async/Await for AVR with Rust</h1><p class="text-gray-600 text-sm mb-6" data-v-47adcb3e><time datetime="2020-07-25T00:00:00.000Z" data-v-47adcb3e>July 25, 2020</time><span class="italic" data-v-47adcb3e>
					· Updated
					<time datetime="2020-07-26T00:00:00.000Z" data-v-47adcb3e>July 26, 2020</time></span>
				· <i data-v-47adcb3e>16 min read</i></p><div class="content mb-10" data-v-47adcb3e><p data-v-47adcb3e><p>With the recent ability for Rust to compile for AVR microcontrollers, I thought that it's time for
me to bring my favorite feature of Rust to Arduino: async/await.</p>
<blockquote>
<p><strong>TL;DR:</strong> final code is at <a href="https://github.com/lights0123/async-avr" target="_blank" rel="nofollow noopener noreferrer">https://github.com/lights0123/async-avr</a>. <a href="https://github.com/lights0123/async-avr/blob/main/examples/serial.rs" target="_blank" rel="nofollow noopener noreferrer">Here's an example of a
simple task that does two things at once</a>.</p>
</blockquote>
<h1 id="introduction"><a href="#introduction" aria-hidden="true"><span class="icon icon-link"></span></a>Introduction</h1>
<p>The <a href="https://www.arduino.cc/en/Tutorial/BlinkWithoutDelay" target="_blank" rel="nofollow noopener noreferrer">age-old</a> <a href="https://arduino.stackexchange.com/questions/49300/blink-without-delay-for-5-times-every-20-seconds" target="_blank" rel="nofollow noopener noreferrer">question</a> <a href="https://arduino.stackexchange.com/questions/44497/how-to-flash-blink-i2c-lcd-backlight-without-delay-function" target="_blank" rel="nofollow noopener noreferrer">when</a> <a href="https://arduino.stackexchange.com/questions/35436/arduino-blink-two-leds-without-delayamount-of-repetitions" target="_blank" rel="nofollow noopener noreferrer">learning</a> <a href="https://arduino.stackexchange.com/questions/37032/how-to-blink-2-led-strips-without-delay" target="_blank" rel="nofollow noopener noreferrer">Arduino</a>:
<em>"<a href="https://arduino.stackexchange.com/questions/73164/blink-not-working" target="_blank" rel="nofollow noopener noreferrer">How can I do</a> <a href="https://arduino.stackexchange.com/questions/49950/how-to-replace-the-delay-function-in-my-code" target="_blank" rel="nofollow noopener noreferrer">multiple things at once</a>"</em>? When programming for full operating
systems, like any desktop, mobile, or higher-end embedded platforms, the answer is easy—threads.
They're built into the OS, and you typically <em>have</em> to use them to take advantage of features like
multiple CPU cores. Or, when programming for an embedded target, you may reach for a lightweight
<abbr title="Real-Time Operating System">RTOS</abbr> like <a href="https://freertos.org/" target="_blank" rel="nofollow noopener noreferrer">FreeRTOS</a>, which gives you full threads without much work.</p>
<p>But what if you have a 16MHz microcontroller with 2 KB of RAM?</p>
<p>The Arduino Uno is known for being ubiquitous, cheap, and easy to program. Although there are more
and more reasons to use competing products, such as the various ARM Cortex-M and Espressif boards
(which I use almost exclusively), the Microchip (formerly Atmel) ATMega series is sometimes still
preferred for low power applications, cutting cents off a <abbr title="Bill of Materials">BOM</abbr>, and its widespread support.</p>
<p>Typically, one checks in a loop repeatedly to see if the task is ready to activate. This can be
checking if there's data in a serial buffer, if a certain time period has passed, or a <abbr title="General-Purpose Input/Output">GPIO</abbr> pin has
toggled. However, I'm going to present an alternative to doing this—<code class="language-text">async</code>/<code class="language-text">await</code>.</p>
<h1 id="what-even-is-asyncawait-anyways"><a href="#what-even-is-asyncawait-anyways" aria-hidden="true"><span class="icon icon-link"></span></a>What even is <code class="language-text">async</code>/<code class="language-text">await</code>, anyways?</h1>
<p>Many modern languages are implementing <code class="language-text">async</code>/<code class="language-text">await</code>. C# was one of the first big languages to do
it, and then Python, JavaScript, Dart, Kotlin quickly followed. The big difference between threads
and <code class="language-text">async</code> functions is that <code class="language-text">async</code>hronous code is handled by the program itself, usually
cooperatively, while synchronous operations on threads rely on the OS to do it. The first obvious
reason for it, then, is when threads aren't available—just like what we're about to get into soon.
However, asynchronous code is typically faster than synchronous code because it is able to avoid the
overhead of spawning threads and context switches, as well as the memory overhead, as the amount of
space needed on the stack can be calculated ahead of time.</p>
<p>Internally, the compiler turns the code into a state machine, typically using the language's
generators feature if it has one. Here, every time you write <code class="language-text">.await</code> and the data is not available
immediately, the compiler inserts a <code class="language-text">return</code> statement, and adds a parameter that allows you to jump
right back to where it was. Rust uses <code class="language-text">Pin</code>ning, where it is guaranteed that the generated struct
that holds the stack will always be in the same place in memory at all times. This avoids a problem
where a pointer is taken to a local variable, the function returns and comes back, and is suddenly
pointing to something completely different.</p>
<h1 id="prior-work"><a href="#prior-work" aria-hidden="true"><span class="icon icon-link"></span></a>Prior work</h1>
<p>C++20 has similar features to Rust's <code class="language-text">async</code>/<code class="language-text">await</code> with the <code class="language-text">co_await</code> keyword, although the
<a href="https://blog.panicsoftware.com/co_awaiting-coroutines/" target="_blank" rel="nofollow noopener noreferrer">available documentation</a> is <a href="https://rust-lang.github.io/async-book/02_execution/04_executor.html" target="_blank" rel="nofollow noopener noreferrer">not quite as good as Rust's</a>.
However, there's a total of... <a href="https://www.arduino.cc/search?q=%22co_await%22&#x26;tab=forum" target="_blank" rel="nofollow noopener noreferrer">1 search result</a> on the Arduino forums, <em>and</em> it's
in German with no code. And even if there <em>was</em> code, it would be largely unaccessable as Arduino
ships with an old compiler:</p>
<div class="gridsome-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">❱ ~/.arduino15/packages/arduino/tools/avr-gcc/*/bin/avr-gcc --version
avr-gcc <span class="token punctuation">(</span>GCC<span class="token punctuation">)</span> <span class="token number">7.3</span>.0
Copyright <span class="token punctuation">(</span>C<span class="token punctuation">)</span> <span class="token number">2017</span> Free Software Foundation, Inc.</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>
<p>GCC 7.3.0 ships with <a href="https://gcc.gnu.org/projects/cxx-status.html#cxx17" target="_blank" rel="nofollow noopener noreferrer">"almost full support"</a> for C++17 (although not by default), but a
total of 0 C++20 additions. And if you're on PlatformIO, you'll have even less luck:</p>
<div class="gridsome-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">❱ ~/.platformio/packages/toolchain-atmelavr/bin/avr-gcc --version
avr-gcc <span class="token punctuation">(</span>AVR_8_bit_GNU_Toolchain_3.6.2_1759<span class="token punctuation">)</span> <span class="token number">5.4</span>.0
Copyright <span class="token punctuation">(</span>C<span class="token punctuation">)</span> <span class="token number">2015</span> Free Software Foundation, Inc.</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>
<p>However, Rust has been able to compile <code class="language-text">async</code>/<code class="language-text">await</code> code for <a href="https://blog.rust-lang.org/2019/11/07/Async-await-stable.html" target="_blank" rel="nofollow noopener noreferrer">almost a year now on the <em>stable
compiler build</em></a>. There's been steadily increasing interest in using these
features on embedded platforms with Rust, and many projects have been using it as a result.</p>
<h2 id="pseudo-asyncawait"><a href="#pseudo-asyncawait" aria-hidden="true"><span class="icon icon-link"></span></a>Pseudo-<code class="language-text">async</code>/<code class="language-text">await</code></h2>
<p>These libraries actually implement a <em>very</em> similar thing to <code class="language-text">async</code>/<code class="language-text">await</code> with a state machine,
and jumping to different positions in code based on where it's already been. For example,
<a href="https://github.com/bxparks/AceRoutine" target="_blank" rel="nofollow noopener noreferrer">AceRoutine</a> has a macro, <code class="language-text">COROUTINE</code>, that internally converts the function into a state machine
that jumps to different places using <code class="language-text">goto</code>. This is actually almost identical to how tools like
Babel in the JavaScript world convert <code class="language-text">async</code> functions to traditional functions that can be used
with old browsers.</p>
<p>However, there are a few very critical problems:</p>
<ul>
<li><strong>Local variables are not preserved across yields</strong>.</li>
<li>You can't use certain statements in some libraries (not AceRoutine), such as <code class="language-text">switch</code>.</li>
<li>Destructors don't run properly, and will <strong><code class="language-text">free</code> uninitialized memory</strong> if not done correctly
(due to the first point).</li>
<li>Tasks can't return values.</li>
</ul>
<p>These limitations are because simple preprocessor macros, which is the only option in C/C++, are
only "glorified copy-paste", and have no real computing power. Although <code class="language-text">async</code> is built into the
Rust compiler, it wasn't before, and a (less-than-ideal, but still usable) macro could implement
most of the feature itself. Hopefully, new C++20 features will lead to more use in the embedded
world.</p>
<h1 id="putting-it-together"><a href="#putting-it-together" aria-hidden="true"><span class="icon icon-link"></span></a>Putting it together</h1>
<h2 id="getting-started"><a href="#getting-started" aria-hidden="true"><span class="icon icon-link"></span></a>Getting started</h2>
<p>It looks like there's a few packages (known as "crates" in the Rust world) to interface with the
hardware:</p>
<ul>
<li><a href="https://github.com/avr-rust/ruduino" target="_blank" rel="nofollow noopener noreferrer">ruduino</a>, which only supports the Arduino Uno</li>
<li><a href="https://github.com/Rahix/avr-device" target="_blank" rel="nofollow noopener noreferrer">avr-device</a>, which provides low-level hardware control</li>
<li><a href="https://github.com/Rahix/avr-hal" target="_blank" rel="nofollow noopener noreferrer">avr-hal</a>, which provides higher-level board and <abbr title="Microcontroller">MCU</abbr> support, and depends on avr-device</li>
</ul>
<p>Although <a href="https://github.com/avr-rust/ruduino" target="_blank" rel="nofollow noopener noreferrer">ruduino</a> is by the avr-rust team that worked on getting Rust working on AVR, I ultimately
decided to go with <a href="https://github.com/Rahix/avr-hal" target="_blank" rel="nofollow noopener noreferrer">avr-hal</a>:</p>
<ul>
<li>It supports many more boards, and has a structure that allows it to expand further</li>
<li>
<p>It supports <a href="https://docs.rs/embedded-hal/0.2.*/embedded_hal/" target="_blank" rel="nofollow noopener noreferrer">embedded-hal</a>, which allows us to share code between boards: for example, the
<a href="https://docs.rs/apa102-spi" target="_blank" rel="nofollow noopener noreferrer"><code class="language-text">apa102_spi</code></a> crate will let us control APA102 LED strips on an Arduino Uno and a Raspberry Pi
running Linux, using the exact same code!</p>
<ul>
<li>embedded-hal also has a bigger focus on nonblocking operations, which is exactly what we're
looking for</li>
</ul>
</li>
<li>It has a cleaner and safer API</li>
</ul>
<p>To set that up:</p>
<p><strong>(Update 2020-07-26)</strong>: this is much simpler now with the latest nightly. All that is required:</p>
<div class="gridsome-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">rustup <span class="token function">install</span> nightly
rustup +nightly component <span class="token function">add</span> rust-src</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>
<h2 id="compiling-and-running"><a href="#compiling-and-running" aria-hidden="true"><span class="icon icon-link"></span></a>Compiling and Running</h2>
<p>We can compile by running</p>
<div class="gridsome-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">cargo +nightly build -Z build-std<span class="token operator">=</span>core --release --target avr-atmega328p.json
<span class="token comment"># or, in my repository which has some helpers configured</span>
cargo +nightly build --release</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>
<p>Then, to upload it to a device, assuming that you have <code class="language-text">avrdude</code> installed, run:</p>
<div class="gridsome-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">avrdude -v -patmega328p -carduino -P/dev/ttyACM0 -b115200 -D -Uflash:w:target/avr-atmega328p/release/examples/serial.elf:e</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>
<p>Change the upload path (<code class="language-text">target/avr-atmega328p/release/examples/serial.elf</code>) to meet what you want
to upload.</p>
<h2 id="if-you-only-have-the-arduino-ide-installed"><a href="#if-you-only-have-the-arduino-ide-installed" aria-hidden="true"><span class="icon icon-link"></span></a>If you only have the Arduino IDE installed</h2>
<p>Enable "Show verbose output during: upload" in the Arduino IDE. Observe the build logs for an
<code class="language-text">avrdude</code> command—it should look something like:</p>
<div class="gridsome-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">/path/to/.arduino15/packages/arduino/tools/avrdude/6.3.0-arduino17/bin/avrdude -C/path/to/.arduino15/packages/arduino/tools/avrdude/6.3.0-arduino17/etc/avrdude.conf -v -patmega328p -carduino -P/dev/ttyACM0 -b115200 -D -Uflash:w:/tmp/arduino_build_721874/Blink.ino.hex:i</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>
<p>Copy that command, but delete everything after <code class="language-text">-Uflash:w:</code>. Then, without spaces, add the path to
your binary. This will typically be <code class="language-text">target/avr-atmega328p/release/project_name.elf</code>, or
<code class="language-text">target/avr-atmega328p/release/examples/example_name.elf</code>. Finally, add <code class="language-text">:e</code>. Your final command
will probably look something like:</p>
<div class="gridsome-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">/path/to/.arduino15/packages/arduino/tools/avrdude/6.3.0-arduino17/bin/avrdude -C/path/to/.arduino15/packages/arduino/tools/avrdude/6.3.0-arduino17/etc/avrdude.conf -v -patmega328p -carduino -P/dev/ttyACM0 -b115200 -D -Uflash:w:target/avr-atmega328p/release/project_name.elf:e</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>
<blockquote>
<h3 id="what-about-converting-to-hex-first"><a href="#what-about-converting-to-hex-first" aria-hidden="true"><span class="icon icon-link"></span></a>What about converting to hex first?</h3>
<p>Arduino typically converts the compiled binary to raw hex, and many AVR-Rust projects have
<a href="https://github.com/Rahix/avr-hal/blob/bfc5dfe67107a68b4a673e54532354af126cb3ba/mkhex.sh#L32" target="_blank" rel="nofollow noopener noreferrer">followed that pattern</a>. However, there's generally no need to do that, as <code class="language-text">avrdude</code>
has the ability to upload ELF binaries directly.</p>
</blockquote>
<h2 id="onto-async-operations"><a href="#onto-async-operations" aria-hidden="true"><span class="icon icon-link"></span></a>Onto <code class="language-text">async</code> operations</h2>
<p>As I mentioned earlier, <a href="https://docs.rs/embedded-hal/0.2.*/embedded_hal/" target="_blank" rel="nofollow noopener noreferrer">embedded-hal</a> is implemented in such a way that asynchronous operations is
quite easy. When you attempt to read or write a value, you can get three results:</p>
<ul>
<li><code class="language-text">WouldBlock</code>: I can't complete this operation right now.</li>
<li><code class="language-text">Ok</code>: The operation succeeded. If reading something, this gives you the read value.</li>
<li><code class="language-text">Err</code>: An error occurred while performing this operation.</li>
</ul>
<p>This maps very nicely to Rust's <code class="language-text">Future</code> trait, which is used to implement asynchronous code. For
example, reading from a serial port is implemented like this:</p>
<div class="gridsome-highlight" data-language="rust"><pre style="counter-reset: linenumber NaN" class="language-rust line-numbers"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">poll_read</span><span class="token punctuation">(</span>
    <span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">:</span> <span class="token class-name">Pin</span><span class="token operator">&lt;</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">Self</span><span class="token operator">></span><span class="token punctuation">,</span>
    cx<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">Context</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'_</span><span class="token operator">></span><span class="token punctuation">,</span>
    buf<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token punctuation">[</span><span class="token keyword">u8</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Poll</span><span class="token operator">&lt;</span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token keyword">usize</span><span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token punctuation">::</span><span class="token class-name">Error</span><span class="token operator">>></span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span> <span class="token operator">=</span> buf<span class="token punctuation">.</span><span class="token function">first_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">match</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token number">0</span><span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Ok</span><span class="token punctuation">(</span>byte<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
                <span class="token operator">*</span>ptr <span class="token operator">=</span> byte<span class="token punctuation">;</span>
                <span class="token class-name">Poll</span><span class="token punctuation">::</span><span class="token class-name">Ready</span><span class="token punctuation">(</span><span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">Err</span><span class="token punctuation">(</span><span class="token namespace">nb<span class="token punctuation">::</span></span><span class="token class-name">Error</span><span class="token punctuation">::</span><span class="token class-name">WouldBlock</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token class-name">Poll</span><span class="token punctuation">::</span><span class="token class-name">Pending</span><span class="token punctuation">,</span>
            <span class="token class-name">Err</span><span class="token punctuation">(</span><span class="token namespace">nb<span class="token punctuation">::</span></span><span class="token class-name">Error</span><span class="token punctuation">::</span><span class="token class-name">Other</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token class-name">Poll</span><span class="token punctuation">::</span><span class="token class-name">Ready</span><span class="token punctuation">(</span><span class="token class-name">Err</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token class-name">Poll</span><span class="token punctuation">::</span><span class="token class-name">Ready</span><span class="token punctuation">(</span><span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>Although there's a bit of weirdness in terms of checking if the buffer is big enough, for the most
part, this works pretty well.</p>
<blockquote>
<h3 id="why-do-i-always-return-1-byte-read"><a href="#why-do-i-always-return-1-byte-read" aria-hidden="true"><span class="icon icon-link"></span></a>Why do I always return 1 byte read?</h3>
<p>I'm mostly mirroring the <code class="language-text">AsyncRead</code> and <code class="language-text">AsyncWrite</code> in the <code class="language-text">futures</code> crate, which typically is
used on machines with full operating systems. Typically, the overhead of a syscall is somewhat
high, so you might request e.g. 1024 bytes at a time. Obviously, that isn't the case for an 8-bit
<abbr title="Microcontroller">MCU</abbr>. However, I'm keeping that pattern for ease of porting and to allow for networking, e.g. the
Arduino Ethernet shield.</p>
</blockquote>
<p>Then, I copied and pasted the <code class="language-text">AsyncReadExt</code> and <code class="language-text">AsyncWriteExt</code> traits from the <code class="language-text">futures</code> crate as
well. The way this is set up is that you just implement the low-level functions, and the <code class="language-text">Ext</code>
traits take care of the more user-friendly functions. This is done instead of default
implementations to allow the main trait to be small in case it is added to the standard library,
much like how <code class="language-text">Future</code> is in <code class="language-text">std</code>/<code class="language-text">core</code>, but many functions require the extension trait
<code class="language-text">FutureExt</code> from the <code class="language-text">futures</code> crate. The functions that <code class="language-text">AsyncReadExt</code> and the like provide allow
for tasks like reading and writing a fixed number of bytes, and <code class="language-text">await</code>ing until that is complete.</p>
<h2 id="writing-an-executor"><a href="#writing-an-executor" aria-hidden="true"><span class="icon icon-link"></span></a>Writing an executor</h2>
<p>Thankfully, there's a few places we can get code from—the Rust embedded team has been working on a
<a href="https://github.com/rust-embedded-community/async-on-embedded/blob/master/async-embedded/src/executor.rs" target="_blank" rel="nofollow noopener noreferrer">generic executor</a>, and <a href="https://github.com/lights0123/ndless-rs/tree/master/ndless-async" target="_blank" rel="nofollow noopener noreferrer">I have my own executor</a> that I've
used for third-party code on TI calculators. I started off with a way to safely share state between
interrupts. Typically, this is done with atomic instructions, but AVR does not have those (or
necessarily have a need for it, as it is single-core). So, I used <code class="language-text">volatile</code> operations:</p>
<div class="gridsome-highlight" data-language="rust"><pre style="counter-reset: linenumber NaN" class="language-rust line-numbers"><code class="language-rust"><span class="token attribute attr-name">#[derive(Debug)]</span>
<span class="token attribute attr-name">#[repr(transparent)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">Volatile</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token class-name">Copy</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token class-name">UnsafeCell</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token class-name">Copy</span><span class="token operator">></span> <span class="token class-name">Volatile</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span>value<span class="token punctuation">:</span> <span class="token class-name">T</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Volatile</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token class-name">Volatile</span><span class="token punctuation">(</span><span class="token class-name">UnsafeCell</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">read</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">T</span> <span class="token punctuation">{</span>
        <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> <span class="token namespace">ptr<span class="token punctuation">::</span></span><span class="token function">read_volatile</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span><span class="token number">0</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">write</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> value<span class="token punctuation">:</span> <span class="token class-name">T</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> <span class="token namespace">ptr<span class="token punctuation">::</span></span><span class="token function">write_volatile</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span><span class="token number">0</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<blockquote>
<h3 id="why-not-the-vcell-crate"><a href="#why-not-the-vcell-crate" aria-hidden="true"><span class="icon icon-link"></span></a>Why not the <code class="language-text">vcell</code> crate?</h3>
<p>The above code is functionally identical to the <a href="https://docs.rs/vcell/0.1.*/vcell/struct.VolatileCell.html" target="_blank" rel="nofollow noopener noreferrer"><code class="language-text">VolatileCell</code></a> that <a href="https://docs.rs/vcell/" target="_blank" rel="nofollow noopener noreferrer"><code class="language-text">vcell</code></a> provides—in fact,
I wrote the above code and realized that it is <em>almost identical</em> to that crate. However, I will
probably want more control in the future, as the above code is <strong>unsound</strong> if used with a type
that is bigger than 1 byte. This is because AVR can write or read one byte in one instruction, so
if an interrupt occurs, it is either written or not. In the future, I'd like to expand it to
disable interrupts when writing more than 1 byte, so state can be safely shared between contexts.</p>
</blockquote>
<h3 id="creating-a-vtable"><a href="#creating-a-vtable" aria-hidden="true"><span class="icon icon-link"></span></a>Creating a VTable</h3>
<p>We need to tell Rust how it can wake up a task. So, doing some copy-pasting from
<a href="https://github.com/rust-embedded-community/async-on-embedded/blob/master/async-embedded/src/executor.rs" target="_blank" rel="nofollow noopener noreferrer">async-on-embedded</a>:</p>
<div class="gridsome-highlight" data-language="rust"><pre style="counter-reset: linenumber NaN" class="language-rust line-numbers"><code class="language-rust"><span class="token comment">// NOTE `*const ()` is &amp;Volatile&lt;bool></span>
<span class="token keyword">static</span> <span class="token constant">VTABLE</span><span class="token punctuation">:</span> <span class="token class-name">RawWakerVTable</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token keyword">unsafe</span> <span class="token keyword">fn</span> <span class="token function-definition function">clone</span><span class="token punctuation">(</span>p<span class="token punctuation">:</span> <span class="token operator">*</span><span class="token keyword">const</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">RawWaker</span> <span class="token punctuation">{</span>
        <span class="token class-name">RawWaker</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token constant">VTABLE</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">unsafe</span> <span class="token keyword">fn</span> <span class="token function-definition function">wake</span><span class="token punctuation">(</span>p<span class="token punctuation">:</span> <span class="token operator">*</span><span class="token keyword">const</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">wake_by_ref</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">unsafe</span> <span class="token keyword">fn</span> <span class="token function-definition function">wake_by_ref</span><span class="token punctuation">(</span>p<span class="token punctuation">:</span> <span class="token operator">*</span><span class="token keyword">const</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>p <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">const</span> <span class="token class-name">Volatile</span><span class="token operator">&lt;</span><span class="token keyword">bool</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">unsafe</span> <span class="token keyword">fn</span> <span class="token function-definition function">drop</span><span class="token punctuation">(</span>_<span class="token punctuation">:</span> <span class="token operator">*</span><span class="token keyword">const</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// no-op</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">RawWakerVTable</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>clone<span class="token punctuation">,</span> wake<span class="token punctuation">,</span> wake_by_ref<span class="token punctuation">,</span> drop<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>Here, I adapted the code to use my own synchronization code instead of <code class="language-text">AtomicBool</code>, which we don't
have access to.</p>
<h3 id="the-block_on-function"><a href="#the-block_on-function" aria-hidden="true"><span class="icon icon-link"></span></a>The <code class="language-text">block_on</code> function</h3>
<p>Finally, it's time for the executor:</p>
<div class="gridsome-highlight" data-language="rust"><pre style="counter-reset: linenumber NaN" class="language-rust line-numbers"><code class="language-rust"><span class="token comment">/// Spawns a task and blocks until the future resolves, returning its result.</span>
<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">block_on</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">></span><span class="token punctuation">(</span>task<span class="token punctuation">:</span> <span class="token keyword">impl</span> <span class="token class-name">Future</span><span class="token operator">&lt;</span><span class="token class-name">Output</span> <span class="token operator">=</span> <span class="token class-name">T</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">T</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> ready <span class="token operator">=</span> <span class="token class-name">Volatile</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> waker <span class="token operator">=</span> <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> <span class="token class-name">Waker</span><span class="token punctuation">::</span><span class="token function">from_raw</span><span class="token punctuation">(</span><span class="token class-name">RawWaker</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ready <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">const</span> _ <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">const</span> _<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token constant">VTABLE</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> context <span class="token operator">=</span> <span class="token class-name">Context</span><span class="token punctuation">::</span><span class="token function">from_waker</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>waker<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">pin_mut!</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> task <span class="token operator">=</span> task<span class="token punctuation">;</span>
    <span class="token keyword">loop</span> <span class="token punctuation">{</span>
        <span class="token keyword">while</span> ready<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">match</span> task<span class="token punctuation">.</span><span class="token function">as_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">Poll</span><span class="token punctuation">::</span><span class="token class-name">Ready</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> val<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token class-name">Poll</span><span class="token punctuation">::</span><span class="token class-name">Pending</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
                    ready<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>This function will accept a <code class="language-text">Future</code>, which is typically automatically generated when writing an
<code class="language-text">async</code> block in Rust. Then, it will poll it. The task will either say that it's done right away, or
register itself to wake up (via the <code class="language-text">waker</code>) when it's ready. Then, it gets polled again, continuing
the cycle.</p>
<p>However, <a href="https://gitter.im/avr-rust/Lobby?at=5f1ca63fbc41f3681724bbba" target="_blank" rel="nofollow noopener noreferrer">LLVM has a bug</a> that crashes the <abbr title="Microcontroller">MCU</abbr> when calling a function pointer.
Unfortunately, that's entirely how <code class="language-text">Waker</code>s are implemented, so let's comment out the part where I
mark it as not ready:</p>
<div class="gridsome-highlight" data-language="diff"><pre style="counter-reset: linenumber 14" class="language-diff line-numbers"><code class="language-diff"><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line">    ready.write(false);
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line"> // ready.write(false);</span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>
<p>This will just poll the task in a busy loop. This isn't great for power usage, but is easy to
implement.</p>
<h1 id="writing-asynchronous-code"><a href="#writing-asynchronous-code" aria-hidden="true"><span class="icon icon-link"></span></a>Writing asynchronous code!</h1>
<h2 id="a-simple-demo"><a href="#a-simple-demo" aria-hidden="true"><span class="icon icon-link"></span></a>A simple demo</h2>
<p>Now that we have the low-level stuff working, we can get on to writing asynchronous code! Let's
start with a <a href="https://github.com/lights0123/async-avr/blob/main/examples/single-task.rs" target="_blank" rel="nofollow noopener noreferrer">basic, single-task only example</a> just to make sure everything
works:</p>
<div class="gridsome-highlight" data-language="rust"><pre style="counter-reset: linenumber NaN" class="language-rust line-numbers"><code class="language-rust"><span class="token attribute attr-name">#[no_mangle]</span>
<span class="token keyword">pub</span> <span class="token keyword">extern</span> <span class="token string">"C"</span> <span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> dp <span class="token operator">=</span> <span class="token namespace">arduino_uno<span class="token punctuation">::</span></span><span class="token class-name">Peripherals</span><span class="token punctuation">::</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> <span class="token keyword">mut</span> pins <span class="token operator">=</span> <span class="token namespace">arduino_uno<span class="token punctuation">::</span></span><span class="token class-name">Pins</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>dp<span class="token punctuation">.</span><span class="token constant">PORTB</span><span class="token punctuation">,</span> dp<span class="token punctuation">.</span><span class="token constant">PORTC</span><span class="token punctuation">,</span> dp<span class="token punctuation">.</span><span class="token constant">PORTD</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> <span class="token keyword">mut</span> serial <span class="token operator">=</span> <span class="token class-name">AsyncSerial</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token namespace">arduino_uno<span class="token punctuation">::</span></span><span class="token class-name">Serial</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>
        dp<span class="token punctuation">.</span><span class="token constant">USART0</span><span class="token punctuation">,</span>
        pins<span class="token punctuation">.</span>d0<span class="token punctuation">,</span>
        pins<span class="token punctuation">.</span>d1<span class="token punctuation">.</span><span class="token function">into_output</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> pins<span class="token punctuation">.</span>ddr<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token number">57600</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token function">block_on</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">{</span>
        <span class="token keyword">loop</span> <span class="token punctuation">{</span>
            serial<span class="token punctuation">.</span><span class="token function">write_all</span><span class="token punctuation">(</span><span class="token string">b"Hello World!\n"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>Compile and upload it:</p>
<div class="gridsome-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">❱ cargo +nightly build --example single-task --release <span class="token operator">&amp;&amp;</span> avrdude -v -patmega328p -carduino -P/dev/ttyACM0 -b115200 -D -Uflash:w:target/avr-atmega328p/release/examples/single-task.elf:e
   Compiling async-avr v0.1.0 <span class="token punctuation">(</span>/home/lights0123/IdeaProjects/async-avr<span class="token punctuation">)</span>
    Finished release <span class="token punctuation">[</span>optimized<span class="token punctuation">]</span> target<span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token number">0</span>.28s

avrdude: Version <span class="token number">6.3</span>-20190619
         Copyright <span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token number">2000</span>-2005 Brian Dean, http://www.bdmicro.com/
         Copyright <span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token number">2007</span>-2014 Joerg Wunsch

avrdude: AVR device initialized and ready to accept instructions

Reading <span class="token operator">|</span> <span class="token comment">################################################## | 100% 0.00s</span>

avrdude: Device signature <span class="token operator">=</span> 0x1e950f <span class="token punctuation">(</span>probably m328p<span class="token punctuation">)</span>
avrdude: safemode: lfuse reads as <span class="token number">0</span>
avrdude: safemode: hfuse reads as <span class="token number">0</span>
avrdude: safemode: efuse reads as <span class="token number">0</span>
avrdude: reading input <span class="token function">file</span> <span class="token string">"target/avr-atmega328p/release/examples/single-task.elf"</span>
avrdude: writing flash <span class="token punctuation">(</span><span class="token number">380</span> bytes<span class="token punctuation">)</span>:

Writing <span class="token operator">|</span> <span class="token comment">################################################## | 100% 0.06s</span>

avrdude: <span class="token number">380</span> bytes of flash written
avrdude: verifying flash memory against target/avr-atmega328p/release/examples/single-task.elf:
avrdude: load data flash data from input <span class="token function">file</span> target/avr-atmega328p/release/examples/single-task.elf:
avrdude: input <span class="token function">file</span> target/avr-atmega328p/release/examples/single-task.elf contains <span class="token number">380</span> bytes
avrdude: reading on-chip flash data:

Reading <span class="token operator">|</span> <span class="token comment">################################################## | 100% 0.05s</span>

avrdude: verifying <span class="token punctuation">..</span>.
avrdude: <span class="token number">380</span> bytes of flash verified

avrdude: safemode: lfuse reads as <span class="token number">0</span>
avrdude: safemode: hfuse reads as <span class="token number">0</span>
avrdude: safemode: efuse reads as <span class="token number">0</span>
avrdude: safemode: Fuses OK <span class="token punctuation">(</span>E:00, H:00, L:00<span class="token punctuation">)</span>

avrdude done.  Thank you.</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>And let's check the serial output:</p>
<div class="gridsome-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">❱ pio device monitor -b <span class="token number">57600</span>
--- Available filters and text transformations: colorize, debug, default, direct, hexlify, log2file, nocontrol, printable, send_on_enter, <span class="token function">time</span>
--- More details at http://bit.ly/pio-monitor-filters
--- Miniterm on /dev/ttyACM0  <span class="token number">57600,8</span>,N,1 ---
--- Quit: Ctrl+C <span class="token operator">|</span> Menu: Ctrl+T <span class="token operator">|</span> Help: Ctrl+T followed by Ctrl+H ---
Hello World<span class="token operator">!</span>
Hello World<span class="token operator">!</span>
Hello World<span class="token operator">!</span>
Hello World<span class="token operator">!</span>
Hello World<span class="token operator">!</span>
Hello World<span class="token operator">!</span>
Hello World<span class="token operator">!</span>
--- <span class="token builtin class-name">exit</span> ---</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h2 id="a-bit-more-powerful"><a href="#a-bit-more-powerful" aria-hidden="true"><span class="icon icon-link"></span></a>A bit more powerful</h2>
<p>Great—that worked! Now, let's try doing multiple things. Let's do <a href="https://github.com/lights0123/async-avr/blob/main/examples/serial.rs" target="_blank" rel="nofollow noopener noreferrer">both SPI communication and
reading UART data now</a>. Starting out with getting our peripherals:</p>
<div class="gridsome-highlight" data-language="rust"><pre style="counter-reset: linenumber NaN" class="language-rust line-numbers"><code class="language-rust"><span class="token keyword">let</span> dp <span class="token operator">=</span> <span class="token namespace">arduino_uno<span class="token punctuation">::</span></span><span class="token class-name">Peripherals</span><span class="token punctuation">::</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> <span class="token keyword">mut</span> pins <span class="token operator">=</span> <span class="token namespace">arduino_uno<span class="token punctuation">::</span></span><span class="token class-name">Pins</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>dp<span class="token punctuation">.</span><span class="token constant">PORTB</span><span class="token punctuation">,</span> dp<span class="token punctuation">.</span><span class="token constant">PORTC</span><span class="token punctuation">,</span> dp<span class="token punctuation">.</span><span class="token constant">PORTD</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> serial <span class="token operator">=</span> <span class="token namespace">arduino_uno<span class="token punctuation">::</span></span><span class="token class-name">Serial</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>
    dp<span class="token punctuation">.</span><span class="token constant">USART0</span><span class="token punctuation">,</span>
    pins<span class="token punctuation">.</span>d0<span class="token punctuation">,</span>
    pins<span class="token punctuation">.</span>d1<span class="token punctuation">.</span><span class="token function">into_output</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> pins<span class="token punctuation">.</span>ddr<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token number">57600</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

pins<span class="token punctuation">.</span>d10<span class="token punctuation">.</span><span class="token function">into_output</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> pins<span class="token punctuation">.</span>ddr<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// CS must be set to output mode.</span>

<span class="token comment">// Create SPI interface.</span>
<span class="token keyword">let</span> spi <span class="token operator">=</span> <span class="token class-name">Spi</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>
    dp<span class="token punctuation">.</span><span class="token constant">SPI</span><span class="token punctuation">,</span>
    pins<span class="token punctuation">.</span>d13<span class="token punctuation">.</span><span class="token function">into_output</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> pins<span class="token punctuation">.</span>ddr<span class="token punctuation">)</span><span class="token punctuation">,</span>
    pins<span class="token punctuation">.</span>d11<span class="token punctuation">.</span><span class="token function">into_output</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> pins<span class="token punctuation">.</span>ddr<span class="token punctuation">)</span><span class="token punctuation">,</span>
    pins<span class="token punctuation">.</span>d12<span class="token punctuation">.</span><span class="token function">into_pull_up_input</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> pins<span class="token punctuation">.</span>ddr<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token class-name">Settings</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>Converting them to async versions:</p>
<div class="gridsome-highlight" data-language="rust"><pre style="counter-reset: linenumber NaN" class="language-rust line-numbers"><code class="language-rust"><span class="token keyword">let</span> <span class="token keyword">mut</span> spi <span class="token operator">=</span> <span class="token class-name">AsyncSpi</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>spi<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> <span class="token punctuation">(</span>rx<span class="token punctuation">,</span> tx<span class="token punctuation">)</span> <span class="token operator">=</span> serial<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> <span class="token keyword">mut</span> rx <span class="token operator">=</span> <span class="token class-name">AsyncSerial</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>rx<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> tx <span class="token operator">=</span> <span class="token class-name">RefCell</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">AsyncSerial</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>tx<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>Some basic locking:</p>
<div class="gridsome-highlight" data-language="rust"><pre style="counter-reset: linenumber NaN" class="language-rust line-numbers"><code class="language-rust"><span class="token keyword">let</span> serial_lock <span class="token operator">=</span> <span class="token class-name">Cell</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>
<blockquote>
<h3 id="why-do-we-need-to-lock"><a href="#why-do-we-need-to-lock" aria-hidden="true"><span class="icon icon-link"></span></a>Why do we need to lock?</h3>
<p>Because we may have multiple tasks trying to write to the same serial port at the same time, we
need to add synchronization so that doesn't happen. Ideally, I would use a <code class="language-text">Mutex</code> that handles
all this for us, but I haven't written one yet (or moreso copied-and-pasted from <a href="https://github.com/rust-embedded-community/async-on-embedded/blob/master/async-embedded/src/unsync/mutex.rs" target="_blank" rel="nofollow noopener noreferrer">one that already
exists</a>).</p>
</blockquote>
<p>Creating a serial loop:</p>
<div class="gridsome-highlight" data-language="rust"><pre style="counter-reset: linenumber NaN" class="language-rust line-numbers"><code class="language-rust"><span class="token keyword">let</span> serial_loop <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">{</span>
    <span class="token keyword">loop</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> b <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        rx<span class="token punctuation">.</span><span class="token function">read_exact</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> b<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">loop</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token operator">!</span>serial_lock<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                serial_lock<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                tx<span class="token punctuation">.</span><span class="token function">borrow_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">write_all</span><span class="token punctuation">(</span><span class="token string">b"hello!\n"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                serial_lock<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">Yield</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<blockquote>
<p>Note: this will not actually <em>run</em> the loop. That comes later.</p>
</blockquote>
<p>Creating an SPI loop:</p>
<div class="gridsome-highlight" data-language="rust"><pre style="counter-reset: linenumber NaN" class="language-rust line-numbers"><code class="language-rust"><span class="token keyword">let</span> spi_loop <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">{</span>
    <span class="token keyword">loop</span> <span class="token punctuation">{</span>
        spi<span class="token punctuation">.</span><span class="token function">write_all</span><span class="token punctuation">(</span><span class="token string">b"a"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> data <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">;</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        spi<span class="token punctuation">.</span><span class="token function">read_exact</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> data<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">loop</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token operator">!</span>serial_lock<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                serial_lock<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">let</span> <span class="token keyword">mut</span> tx_ref <span class="token operator">=</span> tx<span class="token punctuation">.</span><span class="token function">borrow_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                tx_ref<span class="token punctuation">.</span><span class="token function">write_all</span><span class="token punctuation">(</span><span class="token string">b"wrote "</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                tx_ref<span class="token punctuation">.</span><span class="token function">write_all</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                tx_ref<span class="token punctuation">.</span><span class="token function">write_all</span><span class="token punctuation">(</span><span class="token string">b"!\n"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                serial_lock<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">Yield</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">Yield</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<blockquote>
<h3 id="whats-with-all-the-yielding"><a href="#whats-with-all-the-yielding" aria-hidden="true"><span class="icon icon-link"></span></a>What's with all the yielding?</h3>
<p>As Rust implements <em>cooperative</em> multitasking, we need to explicitly give control back to other
tasks. Otherwise, we'd be in a loop waiting for the other task to be done writing, without ever
giving it a chance to write!</p>
</blockquote>
<p>Finally running it:</p>
<div class="gridsome-highlight" data-language="rust"><pre style="counter-reset: linenumber NaN" class="language-rust line-numbers"><code class="language-rust"><span class="token function">block_on</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">{</span> <span class="token namespace">futures_util<span class="token punctuation">::</span></span><span class="token macro property">join!</span><span class="token punctuation">(</span>serial_loop<span class="token punctuation">,</span> spi_loop<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>
<p>Compile and upload it:</p>
<div class="gridsome-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">❱ cargo +nightly build --example serial <span class="token operator">&amp;&amp;</span> avrdude -v -patmega328p -carduino -P/dev/ttyACM0 -b115200 -D -Uflash:w:target/avr-atmega328p/release/examples/serial.elf:e
   Compiling async-avr v0.1.0 <span class="token punctuation">(</span>/home/lights0123/IdeaProjects/async-avr<span class="token punctuation">)</span>
    Finished release <span class="token punctuation">[</span>optimized<span class="token punctuation">]</span> target<span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token number">0</span>.28s

avrdude: Version <span class="token number">6.3</span>-20190619
         Copyright <span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token number">2000</span>-2005 Brian Dean, http://www.bdmicro.com/
         Copyright <span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token number">2007</span>-2014 Joerg Wunsch

avrdude: AVR device initialized and ready to accept instructions

Reading <span class="token operator">|</span> <span class="token comment">################################################## | 100% 0.00s</span>

avrdude: Device signature <span class="token operator">=</span> 0x1e950f <span class="token punctuation">(</span>probably m328p<span class="token punctuation">)</span>
avrdude: safemode: lfuse reads as <span class="token number">0</span>
avrdude: safemode: hfuse reads as <span class="token number">0</span>
avrdude: safemode: efuse reads as <span class="token number">0</span>
avrdude: reading input <span class="token function">file</span> <span class="token string">"target/avr-atmega328p/release/examples/serial.elf"</span>
avrdude: writing flash <span class="token punctuation">(</span><span class="token number">2562</span> bytes<span class="token punctuation">)</span>:

Writing <span class="token operator">|</span> <span class="token comment">################################################## | 100% 0.43s</span>

avrdude: <span class="token number">2562</span> bytes of flash written
avrdude: verifying flash memory against target/avr-atmega328p/release/examples/serial.elf:
avrdude: load data flash data from input <span class="token function">file</span> target/avr-atmega328p/release/examples/serial.elf:
avrdude: input <span class="token function">file</span> target/avr-atmega328p/release/examples/serial.elf contains <span class="token number">2562</span> bytes
avrdude: reading on-chip flash data:

Reading <span class="token operator">|</span> <span class="token comment">################################################## | 100% 0.34s</span>

avrdude: verifying <span class="token punctuation">..</span>.
avrdude: <span class="token number">2562</span> bytes of flash verified

avrdude: safemode: lfuse reads as <span class="token number">0</span>
avrdude: safemode: hfuse reads as <span class="token number">0</span>
avrdude: safemode: efuse reads as <span class="token number">0</span>
avrdude: safemode: Fuses OK <span class="token punctuation">(</span>E:00, H:00, L:00<span class="token punctuation">)</span>

avrdude done.  Thank you.</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>And let's check the serial output:</p>
<div class="gridsome-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">❱ pio device monitor -b <span class="token number">57600</span>
--- Available filters and text transformations: colorize, debug, default, direct, hexlify, log2file, nocontrol, printable, send_on_enter, <span class="token function">time</span>
--- More details at http://bit.ly/pio-monitor-filters
--- Miniterm on /dev/ttyACM0  <span class="token number">57600,8</span>,N,1 ---
--- Quit: Ctrl+C <span class="token operator">|</span> Menu: Ctrl+T <span class="token operator">|</span> Help: Ctrl+T followed by Ctrl+H ---
wrote a<span class="token operator">!</span>
wrote a<span class="token operator">!</span>
wrote a<span class="token operator">!</span>
wrote a<span class="token operator">!</span>
hello<span class="token operator">!</span>
wrote a<span class="token operator">!</span>
wrote a<span class="token operator">!</span>
wrote a<span class="token operator">!</span>
--- <span class="token builtin class-name">exit</span> ---</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>Here, I pressed a key on my keyboard to send a character, which resulted in the reply of "hello!".
This successfully demonstrates multiple tasks running at the same time.</p>
<h1 id="to-do"><a href="#to-do" aria-hidden="true"><span class="icon icon-link"></span></a>To Do</h1>
<p>Right now, this is far from being done and usable. I only have basic for two peripherals: UART and
SPI. More work is required for timers, but once that is done, using <code class="language-text">async</code>/<code class="language-text">await</code> on an Arduino
will be <em>very</em> nice—scheduling a periodic task would be as easy as surrounding it in a <code class="language-text">timeout</code>
function, and waiting for e.g. serial data would not block anything else. Additionally, getting
interrupts to work will allow the <abbr title="Microcontroller">MCU</abbr> to go to sleep while waiting for something to occur, saving
power.</p>
<p>Currently, effort on this is blocked on <a href="https://gitter.im/avr-rust/Lobby?at=5f1ca63fbc41f3681724bbba" target="_blank" rel="nofollow noopener noreferrer">an LLVM issue that prevents calling function
pointers</a>. Until that is fixed, busy-loop polling is the best we can do.</p>
<p>However, <code class="language-text">async</code>/<code class="language-text">await</code> could definitely change the way Arduino code is written. It doesn't have to
be in Rust (although I would definitely not complain :) ), but this style could allow for easier to
write <em>and</em> more power efficient projects.</p>
<h1 id="final-code"><a href="#final-code" aria-hidden="true"><span class="icon icon-link"></span></a>Final code</h1>
<p><a href="https://github.com/lights0123/async-avr" target="_blank" rel="nofollow noopener noreferrer">https://github.com/lights0123/async-avr</a></p>
<h1 id="thanks-to"><a href="#thanks-to" aria-hidden="true"><span class="icon icon-link"></span></a>Thanks to</h1>
<p>These are a few resources that have been helpful.</p>
<p><a href="https://github.com/Rahix/avr-hal" target="_blank" rel="nofollow noopener noreferrer">https://github.com/Rahix/avr-hal</a><br>
<a href="https://github.com/avr-rust/ruduino/issues/9" target="_blank" rel="nofollow noopener noreferrer">https://github.com/avr-rust/ruduino/issues/9</a><br>
<a href="https://github.com/shepmaster/rust-arduino-blink-led-no-core-with-cargo" target="_blank" rel="nofollow noopener noreferrer">https://github.com/shepmaster/rust-arduino-blink-led-no-core-with-cargo</a><br>
<a href="https://github.com/nh2/quadcopter-simulation/blob/8a3652b8a704877156e91c0691ce8ce37588eb53/arduino-accel-rust/src/main.rs#L300-L327" target="_blank" rel="nofollow noopener noreferrer">https://github.com/nh2/quadcopter-simulation/blob/8a3652b8a704877156e91c0691ce8ce37588eb53/arduino-accel-rust/src/main.rs#L300-L327</a></p>
</p></div><div class="comments" style="height:0px;" data-v-47adcb3e><iframe title="Comments" scrolling="no" src="https://utteranc.es/utterances.html?issue-term=title&amp;url=https%3A%2F%2Flights0123.com%2Fblog%2F2020%2F07%2F25%2Fasync-await-for-avr-with-rust%2F&amp;title=Async%2FAwait%20for%20AVR%20with%20Rust&amp;repo=lights0123%2Flights0123.github.io&amp;theme=github-light&amp;label=comments&amp;origin=https%3A%2F%2Flights0123.com"></iframe></div></div></article></main><footer class="bg-ui-sidebar p-8 mt-6" data-v-613304c8><div class="container mx-auto grid md:grid-cols-2 md:gap-4" data-v-613304c8><div data-v-613304c8>
			© 2022 Ben Schattinger <a href="/privacy" class="border-b border-ui-blockquote ml-2" data-v-613304c8>Privacy</a></div><div data-v-613304c8>Suggestions? <a rel="noopener" target="_blank" href="https://github.com/lights0123/lights0123.github.io/issues/new" class="border-b-2 text-ui-emph border-ui-border hover:border-ui-primary" data-v-613304c8>Submit an issue</a></div></div></footer></div><div><noscript><p><img src="&#x2F;&#x2F;matomo.lights0123.com&#x2F;matomo.php?idsite=1&amp;rec=1&url=https%3A%2F%2Flights0123.com%2Fblog%2F2020%2F07%2F25%2Fasync-await-for-avr-with-rust%2F" style="border:0;" alt="" /></p></noscript></div></div>
    <script src="/assets/js/app.1b2a94ac.js" defer></script><script src="/assets/js/page--src--templates--post-vue.46cc7684.js" defer></script>
  </body>
</html>
